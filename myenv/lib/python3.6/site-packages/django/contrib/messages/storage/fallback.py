from django.contrib.messages.storage.base import BaseStorage
from django.contrib.messages.storage.cookie import CookieStorage
from django.contrib.messages.storage.session import SessionStorage


class FallbackStorage(BaseStorage):
    """
<<<<<<< HEAD
    Tries to store all messages in the first backend, storing any unstored
=======
    Try to store all messages in the first backend. Store any unstored
>>>>>>> 37c99181c9a6b95433d60f8c8ef9af5731096435
    messages in each subsequent backend backend.
    """
    storage_classes = (CookieStorage, SessionStorage)

    def __init__(self, *args, **kwargs):
<<<<<<< HEAD
        super(FallbackStorage, self).__init__(*args, **kwargs)
=======
        super().__init__(*args, **kwargs)
>>>>>>> 37c99181c9a6b95433d60f8c8ef9af5731096435
        self.storages = [storage_class(*args, **kwargs)
                         for storage_class in self.storage_classes]
        self._used_storages = set()

    def _get(self, *args, **kwargs):
        """
<<<<<<< HEAD
        Gets a single list of messages from all storage backends.
=======
        Get a single list of messages from all storage backends.
>>>>>>> 37c99181c9a6b95433d60f8c8ef9af5731096435
        """
        all_messages = []
        for storage in self.storages:
            messages, all_retrieved = storage._get()
            # If the backend hasn't been used, no more retrieval is necessary.
            if messages is None:
                break
            if messages:
                self._used_storages.add(storage)
            all_messages.extend(messages)
            # If this storage class contained all the messages, no further
            # retrieval is necessary
            if all_retrieved:
                break
        return all_messages, all_retrieved

    def _store(self, messages, response, *args, **kwargs):
        """
<<<<<<< HEAD
        Stores the messages, returning any unstored messages after trying all
=======
        Store the messages and return any unstored messages after trying all
>>>>>>> 37c99181c9a6b95433d60f8c8ef9af5731096435
        backends.

        For each storage backend, any messages not stored are passed on to the
        next backend.
        """
        for storage in self.storages:
            if messages:
                messages = storage._store(messages, response,
                                          remove_oldest=False)
            # Even if there are no more messages, continue iterating to ensure
            # storages which contained messages are flushed.
            elif storage in self._used_storages:
                storage._store([], response)
                self._used_storages.remove(storage)
        return messages
